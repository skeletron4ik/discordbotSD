import time
from asyncio import tasks
import disnake
from disnake.ext import commands, tasks
from datetime import datetime, timedelta
from pymongo import MongoClient
from datetime import datetime


current_datetime = datetime.today()

cluster = MongoClient(
    "mongodb+srv://Skeletron:1337@cluster0.knkajvi.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0"
)
collusers = cluster.server.users
collservers = cluster.server.servers
collbans = cluster.server.bans


class InfoCog(commands.Cog):
    def __init__(self, bot: commands.Bot):
        self.bot = bot

    @commands.slash_command(name='userinfo', description='–í—ã–≤–æ–¥–∏—Ç –Ω—É–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–µ')
    async def user(self, inter: disnake.ApplicationCommandInteraction, —É—á–∞—Å—Ç–Ω–∏–∫: disnake.Member = None):
        if inter.type == disnake.InteractionType.application_command:
            try:
                await inter.response.defer()
            except Exception as e:
                print(f"Error deferring response: {e}")
                return

        if —É—á–∞—Å—Ç–Ω–∏–∫ is None:
            —É—á–∞—Å—Ç–Ω–∏–∫ = inter.author

        embed = disnake.Embed(title=f"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–µ ``{—É—á–∞—Å—Ç–Ω–∏–∫.name}``:", url="",
                              description="", color=0x00b7ff, timestamp=datetime.now())
        embed.set_author(name=f"{—É—á–∞—Å—Ç–Ω–∏–∫.display_name}",
                         icon_url=f"{—É—á–∞—Å—Ç–Ω–∏–∫.avatar}")
        embed.set_thumbnail(url="https://media0.giphy.com/media/epyCv3K3uvRXw4LaPY/giphy.gif")

        def get_user_info(member):
            try:
                user_data = collusers.find_one({'id': member.id, 'guild_id': inter.guild.id})
                warns_count = user_data.get('warns', 0)
                ban = user_data.get('ban', 'False')
                ban = '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' if ban == 'True' else '–ù–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'
                mute = '–ó–∞–º—É—á–µ–Ω' if member.current_timeout else '–ù–µ –∑–∞–º—É—á–µ–Ω'
                highest_role = sorted(member.roles, key=lambda r: r.position, reverse=True)[0]
                registration_time = member.created_at
                join_time = member.joined_at
                temporary_roles = user_data.get('role_ids', [])
                number_of_roles = user_data.get('number_of_roles', 0)
                message_count = user_data.get('message_count', 0)
                time_in_voice = user_data.get('time_in_voice', 0)
                balance = user_data.get('balance', 0)  # Get the balance from the database

                return warns_count, ban, mute, highest_role, registration_time, join_time, temporary_roles, number_of_roles, message_count, time_in_voice, balance
            except Exception as e:
                print(f"Error getting user info: {e}")
                return (0, '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', None, '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', [], 0, 0, 0, 0)

        warns_count, ban, mute, highest_role, registration_time, join_time, temporary_roles, number_of_roles, message_count, time_in_voice, balance = get_user_info(
            —É—á–∞—Å—Ç–Ω–∏–∫)

        def format_minutes(minutes):
            if 11 <= minutes % 100 <= 19:
                return "–º–∏–Ω—É—Ç"
            elif minutes % 10 == 1:
                return "–º–∏–Ω—É—Ç–∞"
            elif 2 <= minutes % 10 <= 4:
                return "–º–∏–Ω—É—Ç—ã"
            else:
                return "–º–∏–Ω—É—Ç"

        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        status_dict = {
            disnake.Status.online: "üü¢ –í —Å–µ—Ç–∏",
            disnake.Status.offline: "‚ö´Ô∏è –ù–µ –≤ —Å–µ—Ç–∏",
            disnake.Status.idle: "üü° –ù–µ–∞–∫—Ç–∏–≤–µ–Ω",
            disnake.Status.dnd: "üî¥ –ù–µ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å"
        }
        status = status_dict.get(—É—á–∞—Å—Ç–Ω–∏–∫.status, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
        voice_channel = —É—á–∞—Å—Ç–Ω–∏–∫.voice.channel.mention if —É—á–∞—Å—Ç–Ω–∏–∫.voice and —É—á–∞—Å—Ç–Ω–∏–∫.voice.channel else "–ù–µ –≤ –≥–æ–ª–æ—Å–æ–≤–æ–º –∫–∞–Ω–∞–ª–µ"
        current_game = None
        for activity in —É—á–∞—Å—Ç–Ω–∏–∫.activities:
            if isinstance(activity, disnake.Game):
                current_game = activity.name
                break

        try:
            embed.add_field(name=f'',
                            value=f'**–û—Å–Ω–æ–≤–Ω–∞—è —Ä–æ–ª—å:** {highest_role.mention if highest_role else "``–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ``"}',
                            inline=False)
            embed.add_field(name=f'', value=f'**–°—Ç–∞—Ç—É—Å:** ``{status}``', inline=False)
            if —É—á–∞—Å—Ç–Ω–∏–∫.voice and —É—á–∞—Å—Ç–Ω–∏–∫.voice.channel:
                embed.add_field(name=f'',
                                value=f'**–ì–æ–ª–æ—Å–æ–≤–æ–π –∫–∞–Ω–∞–ª:** {voice_channel}', inline=False)
            if current_game:
                embed.add_field(name=f'', value=f'**–ò–≥—Ä–∞–µ—Ç –≤:** ``{current_game}``', inline=False)
            embed.add_field(name=f'', value=f'**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π:\n** ``{message_count}``', inline=True)
            embed.add_field(name=f'',
                            value=f'**–í—Å–µ–≥–æ –≤ –≥–æ–ª–æ—Å–æ–≤–æ–º –∫–∞–Ω–∞–ª–µ:** ``{time_in_voice // 60} {format_minutes(time_in_voice // 60)}``',
                            inline=True)
            embed.add_field(name=f'', value=f'**–ë–∞–ª–∞–Ω—Å:\n** ``{balance}``‚óä', inline=True)
            embed.add_field(name=f'',
                            value=f'**–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:\n** <t:{int(registration_time.timestamp())}:F> (<t:{int(registration_time.timestamp())}:R>)',
                            inline=True)
            embed.add_field(name=f'',
                            value=f'**–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è:\n** <t:{int(join_time.timestamp())}:F> (<t:{int(join_time.timestamp())}:R>)',
                            inline=True)
            embed.add_field(name=f'', value=f'-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-', inline=False)
            embed.add_field(name=f'', value=f'**–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π:\n** ``{warns_count}``', inline=True)
            embed.add_field(name=f'', value=f'**–ë–∞–Ω:\n** ``{ban}``', inline=True)
            embed.add_field(name=f'', value=f'**–ú—É—Ç:\n** ``{mute}``', inline=True)
            embed.add_field(name=f'', value=f'**–í—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä–æ–ª–µ–π:** ``{number_of_roles}``', inline=False)

            if temporary_roles:
                for role_info in temporary_roles:
                    role_id = role_info.get('role_ids')
                    expires_at = role_info.get('expires_at')
                    role = inter.guild.get_role(role_id)
                    if role:
                        embed.add_field(
                            name=f'',
                            value=f'{role.mention} - –∏—Å—Ç–µ–∫–∞–µ—Ç: <t:{int(expires_at)}:R>',
                            inline=False
                        )
            embed.set_footer(text=f'ID: {—É—á–∞—Å—Ç–Ω–∏–∫.id}')

            await inter.edit_original_response(embed=embed)
        except Exception as e:
            print(f"Error editing response: {e}")
            await inter.response.send_message(embed=embed, ephemeral=True)


def setup(bot):
    bot.add_cog(InfoCog(bot))
    print("InfoCog is ready")