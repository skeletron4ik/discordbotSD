import disnake
from disnake.ext import commands
from datetime import datetime
from main import cluster

collusers = cluster.server.users
collservers = cluster.server.servers

class TopEnum(disnake.enums.Enum):
    –†—É–º–±–∏–∫–∏ = "–†—É–º–±–∏–∫–∏"
    –í–æ–π—Å = "–í–æ–π—Å"

class TopCog(commands.Cog):
    def __init__(self, bot):
        self.bot = bot

    def get_top_users(self, skip=0, limit=10):
        top_records = collusers.find().sort('balance', -1).skip(skip).limit(limit)
        return [(record['id'], record['balance']) for record in top_records]

    def get_top_users_voice(self, skip=0, limit=10):
        top_records = collusers.find().sort('time_in_voice', -1).skip(skip).limit(limit)
        return [(record['id'], record['time_in_voice']) for record in top_records]

    def seconds_to_dhm(self, seconds):
        days = seconds // 86400  # 86400 —Å–µ–∫—É–Ω–¥ –≤ –æ–¥–Ω–æ–º –¥–Ω–µ
        hours = (seconds % 86400) // 3600  # 3600 —Å–µ–∫—É–Ω–¥ –≤ –æ–¥–Ω–æ–º —á–∞—Å–µ
        minutes = (seconds % 3600) // 60  # 60 —Å–µ–∫—É–Ω–¥ –≤ –æ–¥–Ω–æ–π –º–∏–Ω—É—Ç–µ
        days = round(days, 0)
        hours = round(hours, 0)
        minutes = round(minutes, 0)

        return days, hours, minutes

    def position_emoji(self, idx):
        if idx == 1:
            return "ü•á"
        elif idx == 2:
            return "ü•à"
        elif idx == 3:
            return "ü•â"
        else:
            return ""

    class TopView(disnake.ui.View):
        def __init__(self, cog, top_type: TopEnum, page=1):
            super().__init__(timeout=60)
            self.cog = cog
            self.top_type = top_type
            self.page = page
            self.items_per_page = 10  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É

            previous_button = disnake.ui.Button(label="‚¨ÖÔ∏è", style=disnake.ButtonStyle.primary)
            previous_button.callback = self.previous_page
            self.add_item(previous_button)

            next_button = disnake.ui.Button(label="‚û°Ô∏è", style=disnake.ButtonStyle.primary)
            next_button.callback = self.next_page
            self.add_item(next_button)

            self.original_message = None

        async def update_embed(self, interaction):
            skip = (self.page - 1) * self.items_per_page

            if self.top_type == '–†—É–º–±–∏–∫–∏':
                top_users = self.cog.get_top_users(skip, self.items_per_page)
                embed = disnake.Embed(title="üèÜ –¢–æ–ø —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ —Ä—É–º–±–∏–∫–∞–º", color=0xffff00, timestamp=datetime.now())
                embed.set_thumbnail(url='https://i.imgur.com/64ibjZo.gif')
                if top_users:
                    for idx, (user_id, balance) in enumerate(top_users, start=skip + 1):
                        member = interaction.guild.get_member(user_id)
                        position_emoji = self.cog.position_emoji(idx)
                        emoji = "<a:rumbick_gif:1276856664842047518>"
                        if balance == 0:
                            if self.original_message.embeds[0].fields[0].name != '–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ —Ç–æ–ø–µ –±–æ–ª—å—à–µ –Ω–µ—Ç':
                                embed.add_field(name=f"–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ —Ç–æ–ø–µ –±–æ–ª—å—à–µ –Ω–µ—Ç",
                                                value=f"", inline=False)
                                await interaction.edit_original_message(embed=embed)
                                return
                            return
                        if member:
                            balance = round(balance, 2)
                            embed.add_field(name=f"{position_emoji} ``#{idx}``. {member.display_name}",
                                            value=f"–ë–∞–ª–∞–Ω—Å: {balance}{emoji}", inline=False)
                        else:
                            balance = round(balance, 2)
                            embed.add_field(name=f"``#{idx}``. ~~–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ (ID: {user_id})~~",
                                            value=f"–ë–∞–ª–∞–Ω—Å: {balance}{emoji}", inline=False)
                else:
                    embed.description = "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å —Ä—É–º–±–∏–∫–∞–º–∏."

            elif self.top_type == '–í–æ–π—Å':
                top_users = self.cog.get_top_users_voice(skip, self.items_per_page)
                embed = disnake.Embed(title="üèÜ –¢–æ–ø —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ –≤–æ–π—Å–µ", color=0xffff00, timestamp=datetime.now())
                embed.set_thumbnail(url='https://i.imgur.com/64ibjZo.gif')
                if top_users:
                    for idx, (user_id, time_in_voice) in enumerate(top_users, start=skip + 1):
                        member = interaction.guild.get_member(user_id)
                        position_emoji = self.cog.position_emoji(idx)
                        emoji = "<a:time:1277018784900845672>"
                        if time_in_voice <= 60:
                            if self.original_message.embeds[0].fields[0].name != '–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ —Ç–æ–ø–µ –±–æ–ª—å—à–µ –Ω–µ—Ç':
                                embed.add_field(name=f"–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ —Ç–æ–ø–µ –±–æ–ª—å—à–µ –Ω–µ—Ç",
                                                value=f"", inline=False)
                                await interaction.edit_original_message(embed=embed)
                                return
                            return
                        if member:
                            days, hours, minutes = self.cog.seconds_to_dhm(time_in_voice)
                            embed.add_field(name=f"{position_emoji} ``#{idx}``. {member.display_name}",
                                            value=f"–í—Ä–µ–º—è –≤ –≤–æ–π—Å–µ: {days} –¥. {hours} —á. {minutes} –º. {emoji}", inline=False)
                        else:
                            days, hours, minutes = self.cog.seconds_to_dhm(time_in_voice)
                            embed.add_field(name=f"``#{idx}``. ~~–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ (ID: {user_id})~~",
                                            value=f"–í—Ä–µ–º—è –≤ –≤–æ–π—Å–µ: {days} –¥. {hours} —á. {minutes} –º. {emoji}", inline=False)
                else:
                    embed.description = "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å –≤—Ä–µ–º–µ–Ω–µ–º –≤ –≤–æ–π—Å–µ."

            self.original_message = await interaction.edit_original_message(embed=embed, view=self)

        async def previous_page(self, interaction: disnake.MessageInteraction):
            await interaction.response.defer()  # –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–¥–µ—Å—å
            if self.page > 1:
                self.page -= 1
                await self.update_embed(interaction)

        async def next_page(self, interaction: disnake.MessageInteraction):
            await interaction.response.defer()  # –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–¥–µ—Å—å
            self.page += 1
            await self.update_embed(interaction)

    @commands.slash_command(name='top', description='–¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏')
    async def top(self, inter: disnake.ApplicationCommandInteraction,
                  —Ç–∏–ø: TopEnum = commands.Param(description="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ç–æ–ø–∞")):
        await inter.response.defer(ephemeral=True)

        view = self.TopView(self, —Ç–∏–ø)
        await view.update_embed(inter)

def setup(bot):
    bot.add_cog(TopCog(bot))
    print('TopCog is ready')
